# Sovereign Sentinel (ORB Engine) - Master System Specification (v32.47)

**CODEBASE TRUTH EDITION**
*This document reflects the exact state of the codebase as of v32.47. Where discrepancies existed, the Code Logic has been prioritized.*

## 1. System Overview
**Name**: Sovereign Sentinel (ORB Engine)
**Version**: v32.47 (Production Codebase)
**Objective**: Autonomous Opening Range Breakout (ORB) trading bot for Trading 212.
**Execution Mode**: **Cron-Triggered Simulation / Burst** (Not a continuous Daemon).
**Broker API**: Trading 212 API v0 (REST).

---

## 2. Project Architecture & Inventory

### 2.1 File Tree (100% Match)
Every file in the repository is categorized below.

#### **Core System (Active)**
```text
Sovereign-Sentinel/
├── .github/workflows/
│   └── deployment.yml           # Active Cron Schedule (Mon-Fri 14:25 UTC)
├── config/
│   ├── orb_config.json          # Active Strategy Config
│   └── config.py                # Config Loader
├── data/
│   ├── ledger_state.json        # MASTER DB: Equity, Positions (Generated by Job A)
│   ├── orb_intel.json           # INTELLIGENCE: Data for Dashboard (Manual/Legacy)
│   └── watchlist.json           # WATCHLIST: Targets for Job A
├── templates/
│   └── base.html                # Jinja2 Dashboard Template
├── main_bot.py                  # ENTRY POINT: The Sentinel
├── generate_isa_portfolio.py    # JOB A: The Auditor (Data Sync)
├── generate_static.py           # JOB B: The Artist (UI Generation)
├── orb_execution.py             # Execution Module (Mock Pricing)
├── orb_shield.py                # Protection Module (Stop/Target Logic)
├── orb_observer.py              # Market Data Module (RVOL)
├── orb_messenger.py             # Telegram Notification Module
├── sovereign_state_manager.py   # State Persistence Logic
└── utils.py                     # Formatting Helpers
```

#### **Utility / Test Scripts (Active for Dev)**
- `activate_live.py`: Manual script to place a LIVE limit order (Connectivity Test).
- `fetch_intelligence.py`: Standalone script to fetch news/prices (Not called by Main Bot).
- `sniper_intelligence.py`: Logic used by Job A/B for target ranking.
- `requirements.txt`: Dependencies.

#### **Deprecated / Legacy / Unused (Do Not Replicate)**
*The following files exist in the repo but are NOT part of the active `main_bot.py` or `deployment.yml` flow.*
- `orb_sidecar.py`: Superseded by `orb_execution.py`.
- `solar_cycle.py`, `immune_system.py`, `oracle.py`: Old logic modules.
- `sentinel_daemon.py`: Logic moved to `main_bot.py`.
- `global_normalization.py`: Merged into `generate_isa_portfolio.py`.
- `.github/workflows/`: `orb_alpha.yml`, `sentinel-daemon.yml`, `orb-autonomous.yml`.
- `debug_*.py`, `test_*.py`, `check_*.py`, `verify_*.py`, `inspect_*.py`: Diagnostic scripts.

---

## 3. Process Lifecycle (Code Logic Truth)

### 3.1 The Sentinel (`main_bot.py`)
**Mode**: **Simulation Loop** (Fixed Duration).
The bot does not run all day. It runs a **5-Minute Burst** (300 seconds) when triggered, designed to fit within GitHub Actions limits (or for testing).

1.  **Startup**:
    - Initializes `SovereignStateManager`.
    - **Circuit Breaker Check**: Explicitly `sys.exit(0)` if `circuit_breaker_tripped` is True in `ledger_state.json`.

2.  **Observation**:
    - Calls `ORBObserver`.
    - **RVOL Logic**: Calculates 5-Day Average Volume via YFinance. (Note: Does not actively filter the watchlist in main loop, just logs).

3.  **Execution Loop (Simulation)**:
    - Loops for **300 Seconds** (5 minutes).
    - **Price Fetching**: `orb_execution.py` > `fetch_current_price(ticker)`.
        - **CODE TRUTH**: Returns `0.0` (Hardcoded Mock).
        - *Implication*: The bot will NOT trade in this version unless this method is updated to hit a real price source.

4.  **Shutdown**:
    - Saves `ledger_state.json`.
    - Executes raw `os.system('git commit ...')` commands to push state.

### 3.2 The Jobs (Auditor & Artist)
- **Job A (`generate_isa_portfolio.py`)**: Fetches T212 Equity, Normalizes Pence->Pounds, Fetches YF Prices for Watchlist, Writes `ledger_state.json`.
- **Job B (`generate_static.py`)**: Reads `ledger_state.json`, reads `orb_intel.json` (if exists), Renders `index.html`.

---

## 4. Operational Logic (Hard Verification)

### 4.1 Trade Execution (`orb_execution.py`)
- **Entries**: Synthetic Limit (Market Order when Price > Level).
- **Position Sizing**: `State Equity * Allocation %`.
- **Logic Cycle**: Checks `current_price >= trigger_long`. (Currently blocked by Mock Pricing returning 0.0).

### 4.2 Shielding (`orb_shield.py`)
- **Trigger**: Called immediately after Entry.
- **Stop Loss**: Sell Order at `Range Low`.
- **Take Profit**: Limit Sell at `Entry Price + (Range * 2.0)`. (Note: Spec previously said High + 2R, Code logic is Entry based).
- **OCO Logic**: `check_oco()` method exists but is `pass` (Empty). No active monitoring of the bracket in this version.

### 4.3 Intelligence
- **Data Source**: `orb_intel.json` is **NOT** generated by `main_bot.py`. It is a manual/external dependency.
- **Sniper List**: Generated by Job A (`generate_isa_portfolio.py`) inside the `sniper_data` block.

---

## 5. Automation Reference

### 5.1 GitHub Actions (`deployment.yml`)
- **Schedule**: `cron: '25 14 * * 1-5'`.
- **Secrets Injection**: `T212_API_KEY`, `T212_API_SECRET`, `TELEGRAM_TOKEN`, `TELEGRAM_CHAT_ID`.
- **Permissions**: Grants `contents: write` for the Git Push in `main_bot.py`.

---

## 6. Replication Checklist (Strict)
To replicate the **exact** functionality of v32.47:

1.  [ ] **Clone Core Files** listed in Section 2.1 (Component 'Core System').
2.  [ ] **Ignore/Delete** files listed in 'Deprecated'.
3.  [ ] **Setup Context**: Create `config/orb_config.json` and `data/ledger_state.json`.
4.  [ ] **Acknowledge Limitations**:
    - Bot runs for 5 minutes only.
    - Bot has Mock Pricing (0.0).
    - Bot has no active OCO monitoring.
5.  [ ] **Run Pipeline**:
    - Step 1: `python generate_isa_portfolio.py` (Updates DB).
    - Step 2: `python generate_static.py` (Updates UI).
    - Step 3: `python main_bot.py` (Runs 5-min Simulation Cycle).
