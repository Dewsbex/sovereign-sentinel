# Sovereign Sentinel (ORB Engine) - Master System Specification (v32.45)

## 1. System Overview
**Name**: Sovereign Sentinel (ORB Engine)
**Version**: v32.45 (Production)
**Objective**: Autonomous Opening Range Breakout (ORB) trading bot for Trading 212, integrated with a high-fidelity dashboard ("Vibe-folio").
**Core Tech Stack**:
- **Engine**: Python 3.10
- **Broker API**: Trading 212 API v0 (REST)
- **Market Data**: YFinance (RVOL), T212 (Live Pricing)
- **Frontend**: HTML5, Tailwind CSS, ApexCharts.js, Jinja2 Templating
- **Orchestration**: GitHub Actions (Cron Schedule)
- **State Management**: JSON-based Persistence (Git as Database)

---

## 2. Project Architecture

### 2.1 File Structure
The application requires the following exact directory structure:

```text
Sovereign-Sentinel/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ deployment.yml       # Cron Schedule & Secrets Injection (Job Runner)
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ orb_config.json          # Strategy Parameters (Risk, Watchlist)
â”‚   â””â”€â”€ config.py                # Python Config Loader
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ ledger_state.json        # "Database" (Equity, Positions, P/L)
â”‚   â”œâ”€â”€ history_log.json         # (Optional) Historical performance log
â”‚   â””â”€â”€ orb_intel.json           # AI Intelligence Data (Targets/Briefing)
â”œâ”€â”€ static/
â”‚   â””â”€â”€ sentinel_crest.png       # Dashboard Asset (Center of Donut)
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ base.html                # Jinja2 Dashboard Template
â”œâ”€â”€ main_bot.py                  # Entry Point (Orchestrator)
â”œâ”€â”€ orb_observer.py              # Market Data Module (RVOL)
â”œâ”€â”€ orb_execution.py             # Trade Execution Module
â”œâ”€â”€ orb_shield.py                # Risk Management Module (OCO Bracket)
â”œâ”€â”€ orb_messenger.py             # Telegram Notification Module
â”œâ”€â”€ generate_static.py           # UI Generator (The "Artist")
â”œâ”€â”€ sovereign_state_manager.py   # Persistence Logic
â”œâ”€â”€ utils.py                     # Financial Formatting Helpers
â””â”€â”€ requirements.txt             # Python Dependencies
```

### 2.2 Dependencies (`requirements.txt`)
Exact package list required for replication:
```text
requests
jinja2
feedparser
yfinance
python-dotenv
pandas
websocket-client
alpha-vantage
```

---

## 3. Configuration Schemas

### 3.1 Strategy Config (`config/orb_config.json`)
Controls the trading logic.
```json
{
    "risk": {
        "initial_capital": 1000.0,
        "max_drawdown_percent": 10.0,
        "trade_allocation_percent": 35.0,
        "min_range_percent": 0.8,
        "max_spread_to_range_ratio": 0.10
    },
    "filters": {
        "min_rvol": 1.5,
        "index_ticker": "SPY",
        "index_correlation_threshold": 0.0
    },
    "time_window": {
        "start_gmt": "14:30",
        "end_observation_gmt": "14:45",
        "hard_stop_gmt": "21:00"
    },
    "watchlist": [
        "TSLA", "NVDA", "AMD", "PLTR", "COIN", "MARA", "MSTR", "NUE", "DHR"
    ]
}
```

### 3.2 Ledger State (`data/ledger_state.json`)
Acts as the persistent database for the bot.
```json
{
    "high_water_mark": 1000.0,
    "current_equity": 1000.0,
    "last_updated": "YYYY-MM-DDTHH:MM:SS.ssssss",
    "daily_performance": {
        "date": "YYYY-MM-DD",
        "pnl": 0.0,
        "trades_taken": 0
    },
    "active_positions": [],
    "circuit_breaker_tripped": false
}
```

---

## 4. Process Lifecycle (The "Sovereign Loop")
Managed by `main_bot.py` on a Daily Cron.

1.  **Startup (14:25 GMT)**:
    - Loads `ledger_state.json`. Checks `circuit_breaker_tripped`.
    - Sends Telegram Alert: "ðŸš€ System Online".

2.  **Observation (14:25 - 14:30 GMT)**:
    - `orb_observer.py` fetches Live Price (T212) and 5-Day Avg Volume (YFinance).
    - Calculates `RVOL`. Only tickers with `RVOL > 1.5` are eligible.

3.  **Execution (14:30 - 21:00 GMT)**:
    - `orb_execution.py` determines the 15-minute Opening Range (High/Low).
    - **Trigger**: Price > Range High.
    - **Action**: Places Market Order (Synthetic Limit).

4.  **Shielding (Immediate Post-Trade)**:
    - `orb_shield.py` places protection orders.
    - **Stop Loss**: Sell Order at `Range Low`.
    - **Take Profit**: Limit Sell at `Range High + (2 * Range)`.

5.  **Shutdown**:
    - Saves state. Commits to Git. notifying Telegram with Daily P/L.

---

## 5. Pixel-Perfect UI Specification

### 5.1 Dashboard Layout (`index.html`)
Generated by `generate_static.py` -> `templates/base.html`.

**Styling Rules**:
- **Framework**: Tailwind CSS.
- **Font**: Inter (UI), JetBrains Mono (Data).
- **Colors**:
    - Green: `#10B981` (Emerald-500)
    - Red: `#F43F5E` (Rose-500)
    - Indigo: `#4F46E5` (Indigo-600)

**Key Components**:
1.  **Market Status Dot**:
    - CSS Class: `w-2.5 h-2.5 rounded-full animate-pulse`
    - Logic: Green (Emerald-500) if 09:30-21:30 GMT, else Red (Rose-500).
2.  **Interactive Legends**:
    - JavaScript `highlightSegment(ticker)` acts on both Donut Slices and Grid items.
3.  **Sparklines**:
    - SVG Paths rendered inline for mobile targets list.

### 5.2 Helper Utils (`utils.py`)
Critical for financial display accuracy. The system uses **Truncation** (Floor), NOT Rounding, for display.

```python
def truncate_decimal(value, places=2):
    # Multiplies by 10^places, floors, then divides.
    # 12.3456 -> 12.34 (Not 12.35)
```

---

## 6. API Integration Reference (Trading 212 v0)

**Base URL**: `https://live.trading212.com/api/v0/equity`

### 6.1 Verified Endpoints & Payloads (v32.43 Audit)

| Function | Endpoint | Method | Payload Key Keys | Rules |
| :--- | :--- | :--- | :--- | :--- |
| **Market Order** | `/orders/market` | POST | `ticker`, `quantity` | `quantity` must be **Signed** (+/-). |
| **Limit Order** | `/orders/limit` | POST | `ticker`, `quantity`, `limitPrice`, `timeValidity` | Use `GTC`, not `GOOD_TILL_CANCEL`. |
| **Stop Order** | `/orders/stop` | POST | `ticker`, `quantity`, `stopPrice`, `timeValidity` | Quantity must be Negative for Sell. |

---

## 7. Automation & Deployment

### 7.1 GitHub Actions (`.github/workflows/deployment.yml`)
- **Schedule**: `cron: '25 14 * * 1-5'`
- **Secrets Required**:
    - `T212_API_KEY`, `T212_API_SECRET`
    - `TELEGRAM_TOKEN`, `TELEGRAM_CHAT_ID`
- **Permissions**: `contents: write` (Required for State Persistence)

---

## 8. Replication Checklist
To clone this system exactly:
1.  [ ] Replicate **Directory Structure** from Section 2.1.
2.  [ ] Install **Dependencies** from Section 2.2.
3.  [ ] Create **JSON Config Files** using Schemas in Section 3.
4.  [ ] Place `sentinel_crest.png` in `/static`.
5.  [ ] Implement `utils.py` with **Truncation Logic**.
6.  [ ] Deploy to GitHub and set **Secrets**.
7.  [ ] Verify API Connectivity using `verify_live_trade.yml`.
