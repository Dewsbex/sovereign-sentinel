# Sovereign Sentinel (ORB Engine) - Master System Specification (v32.44)

## 1. System Overview
**Name**: Sovereign Sentinel (ORB Engine)
**Version**: v32.44 (Production)
**Objective**: Autonomous Opening Range Breakout (ORB) trading bot for Trading 212, integrated with a high-fidelity dashboard ("Vibe-folio").
**Core Tech Stack**:
- **Engine**: Python 3.10
- **Broker API**: Trading 212 API v0 (REST)
- **Market Data**: YFinance (RVOL), T212 (Live Pricing)
- **Frontend**: HTML5, Tailwind CSS, ApexCharts.js, Jinja2 Templating
- **Orchestration**: GitHub Actions (Cron Schedule)
- **State Management**: JSON-based Persistence (Git as Database)

---

## 2. Process Architecture & Lifecycle

### 2.1 The "Sovereign Finality" Loop
The system operates on a strict daily lifecycle managed by `main_bot.py`.

1.  **Startup (14:25 GMT)**:
    - Triggered by GitHub Actions (`deployment.yml`).
    - Initializes `SovereignStateManager`.
    - Checks `circuit_breaker_tripped` flag in `ledger_state.json`.
    - Sends Telegram Alert: "ðŸš€ System Online".

2.  **Observation Phase (14:25 - 14:30 GMT)**:
    - Managed by `orb_observer.py`.
    - Analyzes RVOL (Relative Volume) via YFinance to determine market heat.
    - Sets initial "Opening Range" High/Low markers (Simulation Mode for v1).

3.  **Execution Phase (14:30 - 21:00 GMT)**:
    - Managed by `orb_execution.py`.
    - **Strategy**: 15-Minute Opening Range Breakout (ORB).
    - **Trigger**: Price breaks above `Range High`.
    - **Entry**: Market Order (Synthetic Limit).
    - **Payload Logic**:
        - **Ticker**: `{SYMBOL}_US_EQ` (e.g., `DHR_US_EQ`).
        - **Quantity**: Signed Float (`+1.0` = BUY, `-1.0` = SELL).
        - **TimeValidity**: `DAY`.

4.  **Shield Activation (Post-Trade)**:
    - Managed by `orb_shield.py`.
    - Immediately places an **OCO Bracket** (One-Cancels-Other):
        - **Stop Loss**: Sell Order at `Range Low` (Risk).
        - **Take Profit**: Limit Sell at `Range High + (Range * 2.0)` (Reward).

5.  **Shutdown & Persistence**:
    - Saves updated state to `ledger_state.json`.
    - Commits state to GitHub repository ("State Update [Skip CI]").
    - Sends Telegram Alert: "ðŸ’¤ System Shutdown (P/L Report)".

---

## 3. Pixel-Perfect UI Specification ("The Vibe-folio")

### 3.1 Dashboard Layout (`index.html`)
The dashboard is a static HTML file generated by `generate_static.py` using `templates/base.html`.

#### **Design Language**
- **Framework**: Tailwind CSS (CDN).
- **Fonts**: 'Inter' (Body), 'JetBrains Mono' (Data/Headers).
- **Palette**:
    - Background: `#F3F4F6` (Gray-100)
    - Surface: `#FFFFFF` (White)
    - Accents: `#4F46E5` (Indigo-600), `#10B981` (Emerald-500), `#F43F5E` (Rose-500).

#### **Core Components**

1.  **Nav Bar (Fixed)**:
    - **Left**: "Vibe-folio Sentinel" + Pulsing Dot (Green/Red based on market hours).
    - **Center**: Key Metrics (Wealth, Total Return, Cash Dry, Pending).
    - **Right**: Env Badge ("LIVE"), Last Sync Time.
    - **Logic**: JS `updateMarketStatus()` runs every minute to toggle "LIVE"/"CLOSED" badges independently of Python.

2.  **Heatmap Section (Top Left)**:
    - **Chart**: ApexCharts Treemap.
    - **Data**: Injected via `heatmap_dataset` JSON.
    - **Interactivity**: Hover shows custom Tooltip; Click highlights Legend.
    - **"See All"**: Toggles a full specific table view.

3.  **Asset Allocation (Top Right)**:
    - **Visual**: Custom SVG Donut Ring generated in Python (`generate_oracle_ring`).
    - **Features**:
        - "Leader Lines" pointing to slices.
        - Center Crest (`sentinel_crest.png`).
        - **Compact Legend**: Grid of tickers below the chart.

4.  **Operational Intelligence (Bottom)**:
    - **AI Brief**: HTML content injected from `orb_intel.json`.
    - **Target Tracker**: Table/List of watched tickers with Trigger/Stop/Limit prices.
    - **Sparklines**: SVG Path elements rendered inline for mobile list view.

### 3.2 Generator Logic (`generate_static.py`)
- **Input**: `live_state.json` (Portfolio Data), `orb_intel.json` (AI Brief/Targets).
- **Processing**:
    - Calculates Total Return (Realized + Unrealized + Divs + Interest - Fees).
    - Generates SVG strings for the Donut Chart.
    - Formats numbers (Money: `Â£1,234.56`, Pct: `+12.3%`).
- **Output**: Renders Jinja2 template to `index.html`.

---

## 4. API Integration Reference (Trading 212 v0)

**Base URL**: `https://live.trading212.com/api/v0/equity`
**Auth**: Basic Auth (`T212_API_KEY`, `T212_API_SECRET`)

### 4.1 Endpoints Used

| Function | Endpoint | Method | Payload Key Keys | Verified Spec |
| :--- | :--- | :--- | :--- | :--- |
| **Market Order** | `/orders/market` | POST | `ticker`, `quantity` (+/-) | âœ… v32.43 |
| **Limit Order** | `/orders/limit` | POST | `ticker`, `quantity` (+/-), `limitPrice`, `timeValidity` | âœ… v32.43 |
| **Stop Order** | `/orders/stop` | POST | `ticker`, `quantity` (-), `stopPrice`, `timeValidity` | âœ… v32.43 |
| **Positions** | `/positions` | GET | N/A | Returns List |
| **History** | `/history/transactions` | GET | Params: `limit` | Items have `dateTime` |

### 4.2 Critical Payload Rules (v32.43 Audit)
1.  **Ticker Format**: Must include suffix (e.g., `_US_EQ`).
2.  **Direction**: Determined by **SIGN** of `quantity`.
    - `1.0` = Buy
    - `-1.0` = Sell
3.  **No Side Field**: The `side` parameter is deprecated/ignored.
4.  **TimeValidity**: Must be `"DAY"` or `"GTC"`. "GOOD_TILL_CANCEL" is invalid.

---

## 5. Automation Triggers (GitHub Actions)

### 5.1 Deployment Workflow (`deployment.yml`)
- **Schedule**: `cron: '25 14 * * 1-5'` (Mon-Fri 14:25 UTC).
- **Environment**: Ubuntu Latest, Python 3.10.
- **Secrets Injection**:
    - `T212_API_KEY`, `T212_API_SECRET`
    - `TELEGRAM_TOKEN`, `TELEGRAM_CHAT_ID`
- **Permissions**: `contents: write` (for Git Push).

### 5.2 Verification Workflows
- **Live Trade Verification**: `verify_live_trade.yml` (Manual Trigger).
    - Runs `activate_live.py` to place a confirmed safe limit order (Verification of Connectivity).

---

## 6. Replication Guide

To replicate this system:
1.  **Clone Repo**.
2.  **Set Secrets** in GitHub (API Keys, Telegram).
3.  **Install Python Deps**: `requests`, `yfinance`, `jinja2`, `pandas`.
4.  **Run Initialization**:
    - Create `config/orb_config.json`.
    - Create `data/ledger_state.json`.
5.  **Enable Workflow**: Un-comment schedule in `.github/workflows/deployment.yml`.
