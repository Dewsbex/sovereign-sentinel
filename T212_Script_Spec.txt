===================================================================================
TRADING 212 API DATA FEED - GOLDEN SPECIFICATION
===================================================================================

Purpose: Generate a single "Source of Truth" file that solves FX, Weighting, and P/L 
problems for the Sovereign Sentinel dashboard.

===================================================================================
üõ†Ô∏è DEVELOPER SPECIFICATION
===================================================================================

**Objective:** Query the Trading 212 API to generate a single file named `ISA_PORTFOLIO.csv`.
**API Base:** `https://live.trading212.com` (or `demo` if testing).
**Required Header:** `Authorization: <YOUR_API_KEY>`
**Note:** The script must load the API Key securely (e.g., from a `.env` file or user input). DO NOT hardcode the key.

-----------------------------------------------------------------------------------
STEP 1: Fetch Account Cash (The Denominator)
-----------------------------------------------------------------------------------

**Endpoint:** `GET /api/v0/equity/account/cash`

**Data Needed:**
1. `free` (The cash sitting in your account earning interest).
2. `total` (The total account value: Cash + Invested).

-----------------------------------------------------------------------------------
STEP 2: Fetch Portfolio Holdings (The Numerators)
-----------------------------------------------------------------------------------

**Endpoint:** `GET /api/v0/equity/portfolio`

**Data Needed (per position):**
1. `ticker` (e.g., "AAPL")
2. `quantity` (Number of shares)
3. `averagePrice` (Your buy price in the **stock's currency** e.g., USD)
4. `currentPrice` (Live price in the **stock's currency**)
5. `ppl` (Total Profit/Loss converted to your **Base Currency/GBP**)
6. `fxPpl` (The specific Profit/Loss caused by Currency fluctuations in **Base Currency/GBP**)
7. `value` (Total value in Base Currency - if available, otherwise calculate).

-----------------------------------------------------------------------------------
STEP 3: The CSV Output Structure
-----------------------------------------------------------------------------------

The script must generate a CSV with these **exact headers**. The logic for the 
"Derived Columns" is critical.

**Filename:** `ISA_PORTFOLIO.csv`

+---------------------+------------------------------------------------+----------------------------------+
| CSV Header          | API Source / Calculation Logic                 | Why Gemini Needs This            |
+---------------------+------------------------------------------------+----------------------------------+
| Ticker              | `ticker`                                       | To identify the asset.           |
+---------------------+------------------------------------------------+----------------------------------+
| Status              | Hardcode as `"Holding"`                        | To trigger the "Fortress" logic. |
+---------------------+------------------------------------------------+----------------------------------+
| Shares              | `quantity`                                     | To calculate "Satiation"         |
|                     |                                                | (Overweight check).              |
+---------------------+------------------------------------------------+----------------------------------+
| Avg Price (Local)   | `averagePrice`                                 | To check technical performance   |
|                     |                                                | (Stock vs. Stock).               |
+---------------------+------------------------------------------------+----------------------------------+
| Live Price (Local)  | `currentPrice`                                 | To check current valuation vs.   |
|                     |                                                | 5yr Avg P/E.                     |
+---------------------+------------------------------------------------+----------------------------------+
| Currency            | Extract from metadata OR infer                 | To know if we apply 0.5% Stamp   |
|                     |                                                | Duty (GBP) or 0.15% FX (USD).    |
+---------------------+------------------------------------------------+----------------------------------+
| Book Cost (¬£)       | **THE GOLDEN FORMULA:**                        | **CRITICAL:** This solves the FX |
|                     | `Current Value (¬£) - Real P/L (¬£)`             | Purchase Date issue. It tells    |
|                     |                                                | Gemini exactly how much GBP you  |
|                     | *Logic:* Calculate current GBP value           | spent.                           |
|                     | (using live FX) subtract total GBP P/L.        |                                  |
+---------------------+------------------------------------------------+----------------------------------+
| Real P/L (¬£)        | `ppl`                                          | The absolute truth of your       |
|                     |                                                | return.                          |
+---------------------+------------------------------------------------+----------------------------------+
| FX Impact (¬£)       | `fxPpl`                                        | Allows Gemini to say: "Stock is  |
|                     |                                                | up, but you are losing money     |
|                     |                                                | because GBP is strong."          |
+---------------------+------------------------------------------------+----------------------------------+

-----------------------------------------------------------------------------------
STEP 4: Handling the "Cash" Row
-----------------------------------------------------------------------------------

To solve the "Portfolio Weighting" issue, the script must add **one final row** 
to the CSV representing your uninvested cash.

* **Ticker:** `CASH_GBP`
* **Status:** `Liquidity`
* **Shares:** `1`
* **Live Price (Local):** Insert the value of `free` from Step 1.
* **Book Cost (¬£):** Insert the value of `free` from Step 1.

-----------------------------------------------------------------------------------
STEP 5: File Saving Location (Google Drive Sync)
-----------------------------------------------------------------------------------

The script must automatically save the file to Google Drive for cloud syncing.

1. **Path Checking Logic:**
   - Check if directory `G:/My Drive/` exists.
   - ELSE check if directory `~/Google Drive/` exists.
   - IF NEITHER exists, save to the local script directory and print a warning.

2. **Filename:** `ISA_PORTFOLIO.csv`

3. **Action:** ALWAYS overwrite the existing file. This ensures the dashboard 
   always pulls the latest 100% accurate data.

===================================================================================
üìù EXAMPLE "PERFECT CSV" CONTENT
===================================================================================

This is what the file should look like when the script runs:

```
Ticker,Status,Shares,Avg Price (Local),Live Price (Local),Currency,Book Cost (¬£),Real P/L (¬£),FX Impact (¬£)
AAPL,Holding,10,150.00,175.00,USD,1200.50,150.25,-45.00
RIO,Holding,102,45.96,67.00,GBP,4687.92,2146.08,0.00
CASH_GBP,Liquidity,1,5000.00,5000.00,GBP,5000.00,0.00,0.00
```

===================================================================================
üß† HOW THIS UPGRADES THE PROMPT
===================================================================================

With this file, we can strip out 40% of the complex python guessing game from 
the prompt.

* **Old Way:** "Estimate historical FX rate to guess cost basis." (Prone to error).
* **New Way:** "Read `FX Impact (¬£)` column." (100% Accuracy).

===================================================================================
KEY BENEFITS
===================================================================================

1. **Single Source of Truth:** One CSV file contains all portfolio data with 
   accurate GBP-based calculations.

2. **No FX Guesswork:** The Trading 212 API provides actual FX impact, eliminating 
   the need to estimate historical exchange rates.

3. **True Portfolio Weighting:** Including CASH_GBP row enables accurate 
   calculation of asset allocation percentages.

4. **Accurate P/L Attribution:** Separates stock performance from currency effects, 
   enabling better investment decisions.

5. **Transaction Cost Aware:** Currency field enables correct application of 
   UK Stamp Duty (0.5% for GBP) vs FX fees (0.15% for USD).

===================================================================================
END OF SPECIFICATION
===================================================================================
